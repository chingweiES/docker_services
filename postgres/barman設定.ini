變更
pg_hba.conf 執行 SELECT pg_reload_conf();


gosu barman barman check all

gosu barman psql -h service_postgres -U peter -d mydb -c "SELECT 1;"
gosu barman psql -h service_postgres -U peter -d mydb -c "IDENTIFY_SYSTEM;"
gosu barman psql "host=service_postgres user=peter dbname=mydb replication=1" -c "IDENTIFY_SYSTEM"


barman switch-xlog --force pg-server  # 測試是否能切換日誌
barman receive-wal --create-slot pg-server




gosu barman barman receive-wal pg-server 



curl -fsSL https://www.postgresql.org | gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg && echo "deb http://apt.postgresql.org noble-pgdg main" > /etc/apt/sources.list.d/pgdg.list


RPO
RTO

Postgres 中，邏輯備份是透過 `git log-backup` 和 `git log-update` 工具實現pg_dump的pg_dumpall


分為三種類型：完整備份、增量備份和差異備份。
full, incremental and differential.

完整備份: （通常也稱為基礎備份） base backup

增量備份: 則旨在僅擷取自上次備份以來發生的變更。上次備份可以是完整備份，也可以是另一個增量備份
差異備份: 與增量備份類似，都只記錄自上次備份以來所做的變更。關鍵區別在於，差異備份始終記錄相對於完整備份的更改，而不是相對於增量備份或其他差異備份的更改。

Transaction logs:交易日誌

* 一系列連續的文件組成，記錄資料庫中每個操作在執行之前的狀態。
* 包含了資料庫在一段時間內發生的所有變更
* 交易日誌會在所有操作持久化後被回收。然而，如果我們能夠提前歸檔這些日誌，實際上就保留了資料庫所有變更的完整記錄
* 基礎備份與交易日誌歸檔結合，可實現持續備份 (這對於無法定期進行完整備份的大型資料庫尤其重要。)
* 它與差異備份的目標類似，但功能更強大，因為它還支援更強大的功能，例如時間點復原(point-in-time recovery)。

時間點復原(point-in-time recovery):
* 將資料庫還原到從基礎備份結束時間到已歸檔交易日誌所覆蓋的最遠時間點之間的任何特定時刻
* 透過維護交易日誌的持續歸檔，您可以重現資料庫迄今為止的所有變更。
* 
* 
* 
pg_dump: 邏輯備份
pg_basebackup : 物理備份



Barman 使用 backup_method = rsync 來實作  Postgres low-level API

Write-ahead logs (WAL): 預寫式日誌
* Postgres（以及其他資料庫）對交易日誌的稱呼
* 每個 WAL 檔案支援 16 MB 的變更
* 任何對資料檔案（表格和索引）的修改，都必須先記錄在日誌中，且日誌必須先寫入硬碟（Persistent Storage），修改後的資料才能真正寫入硬碟

WAL 可以:
* 故障恢復, 提升效能,
* 備份與複製: 串流複製 (Streaming Replication) 和時間點恢復 (PITR) 的基礎


fsync： 這是確保 WAL 真正落盤的操作。只有當 fsync 成功後，事務才會向客戶端回傳「已提交」。 
flush data to disk for crash safety

WAL archiving 以及 WAL streaming
* Postgres中: Transaction logs 被稱為 continuous archiving” or “WAL archiving
* 透過 archive_command 在WAL 回收前做歸檔。

archive_command
* 命令必須返回零退出狀態，否則，Postgres 會認為歸檔失敗，並且不會回收這些文件，直到它們能夠成功歸檔為止。
* 若失敗，WAL 檔案會不斷堆積，直到命令再次正常工作或磁碟空間耗盡。
* 一般與rsync搭配使用。將 WAL 檔案直接歸檔到 Barman 上伺服器的專用目錄 (兩個方法之一)
* 指令可以是 rsync 指令（需要手動指定 Barman 主機上伺服器的 WAL 目錄）
* barman-wal-archive僅需伺服器名稱的公用程式（Barman 會自動處理其餘操作）
* 該方法barman-wal-archive還透過確保檔案在接收後立即進行 fsync 同步來提高安全性。

WAL streaming
* 將 WAL 檔案直接歸檔到 Barman 上伺服器的專用目錄 (兩個方法之一)
* 搭配  streaming backups 使用，需要 pg_receivewal 
* 建立 Replication Slot


pg_receivewal: 也可以做歸檔
* 使用 streaming replication protocol
* 檔案可以即時傳輸，無需等待 WAL 段完全填滿即可開始傳輸，
* 強烈建議使用 replication slots。


Recovery:

物理備份
* 需要 cluster files 以及 WAL archive


確認步驟:
如果復原過程涉及 Postgres 增量備份，則需要先使用pg_combinebackup. 將所有備份合併


Rsync backups: backup_method = rsync
* Postgres 底層 API，Rsync 透過 SSH 連線手動傳輸叢集檔案
* 同一台主機或透過網路在不同主機之間同步檔案和目錄

Streaming Backups: backup_method = postgres
* 


Snapshot Backups: backup_method = snapshot
* 

File-level incremental backups
* Rsync


Block-level incremental backups
* Streaming Backups
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 

* 
* 
* 
* 
* 
* 
* 